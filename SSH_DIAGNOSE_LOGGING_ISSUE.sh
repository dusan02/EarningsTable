#!/bin/bash
# Diagnostika prečo sa logy nezapisujú

cd /srv/EarningsTable && echo "═══════════════════════════════════════════════════════════" && echo "DIAGNÓZA: PREČO SA LOGY NEZAPISUJÚ?" && echo "═══════════════════════════════════════════════════════════" && echo "" && echo "1. Kontrola systemd service:" && systemctl is-active earnings-cron && echo "" && echo "2. Posledné logy z earnings-cron (hľadanie 'updateCronStatus' alebo 'cron_execution_log'):" && journalctl -u earnings-cron -n 100 --no-pager | grep -E "updateCronStatus|cron_execution_log|Failed to log|Starting.*execution|completed successfully" | tail -20 || echo "Žiadne relevantné logy" && echo "" && echo "3. Kontrola či sa pipeline spúšťa:" && journalctl -u earnings-cron -n 200 --no-pager | grep -E "Pipeline|runPipeline|Starting.*pipeline" | tail -10 || echo "Žiadne pipeline logy" && echo "" && echo "4. Kontrola chýb v logoch:" && journalctl -u earnings-cron -n 200 --no-pager | grep -E "Error|Failed|❌" | tail -10 || echo "Žiadne chyby" && echo "" && echo "5. Kontrola či sa volá updateCronStatus s startedAt:" && journalctl -u earnings-cron --since "1 hour ago" --no-pager | grep -E "Starting.*execution|updateCronStatus" | tail -10 || echo "Žiadne relevantné logy za poslednú hodinu" && echo "" && echo "6. Kontrola databázovej chyby (ak existuje):" && sqlite3 modules/database/prisma/prod.db "SELECT sql FROM sqlite_master WHERE type='table' AND name='cron_execution_log';" | head -5

