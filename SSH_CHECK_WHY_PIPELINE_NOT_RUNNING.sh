#!/bin/bash
# Kontrola prečo sa pipeline nespúšťa

cd /srv/EarningsTable && echo "═══════════════════════════════════════════════════════════" && echo "DIAGNÓZA: PREČO SA PIPELINE NESPÚŠŤA?" && echo "═══════════════════════════════════════════════════════════" && echo "" && echo "1. Kontrola čo sa spúšťa (hľadanie 'Starting.*execution' vs 'Pipeline'):" && journalctl -u earnings-cron -n 500 --no-pager | grep -E "Starting.*execution|Pipeline|runPipeline|unified-slot|CRON.*tick" | tail -20 || echo "Žiadne relevantné logy" && echo "" && echo "2. Kontrola či sa unified pipeline naplánoval:" && journalctl -u earnings-cron --since "1 hour ago" --no-pager | grep -E "Unified pipeline scheduled|All cron jobs started" | tail -5 || echo "Žiadne logy o naplánovaní" && echo "" && echo "3. Kontrola cron tickov (každých 5 min):" && journalctl -u earnings-cron --since "1 hour ago" --no-pager | grep -E "CRON.*tick|unified-slot" | tail -10 || echo "Žiadne cron ticky" && echo "" && echo "4. Kontrola quiet window:" && journalctl -u earnings-cron --since "1 hour ago" --no-pager | grep -E "Quiet window|skipping tick" | tail -5 || echo "Žiadne quiet window logy" && echo "" && echo "5. Kontrola či sa spúšťajú staré joby (FinnhubCronJob/PolygonCronJob):" && journalctl -u earnings-cron --since "1 hour ago" --no-pager | grep -E "FinnhubCronJob|PolygonCronJob|Starting.*CronJob" | tail -5 || echo "Žiadne staré joby" && echo "" && echo "6. Kontrola kódu - čo sa skutočne spúšťa:" && echo "   Hľadanie 'runFinnhubJob' alebo 'runPolygonJob' v logoch:" && journalctl -u earnings-cron --since "1 hour ago" --no-pager | grep -E "runFinnhubJob|runPolygonJob" | tail -5 || echo "Žiadne priame volania jobov"

