#!/bin/bash
# Full test of API and database logic on SSH

cd /srv/EarningsTable && echo "=== 1. Check if earnings-table service is running ===" && systemctl is-active earnings-table && echo "" && echo "=== 2. Test API endpoint /api/final-report ===" && curl -s http://localhost:5555/api/final-report | jq -r 'if .success then "✅ API Success: " + (.count | tostring) + " companies" else "❌ API Error: " + (.error // .message // "Unknown") end' 2>/dev/null || (echo "❌ API request failed or jq not available" && curl -s http://localhost:5555/api/final-report | head -20) && echo "" && echo "=== 3. Check database - total companies ===" && sqlite3 modules/database/prisma/prod.db "SELECT COUNT(*) as total FROM final_report;" && echo "" && echo "=== 4. Check database - sample companies (top 5 by marketCap) ===" && sqlite3 -header -column modules/database/prisma/prod.db "SELECT symbol, name, marketCap, price, change FROM final_report WHERE marketCap IS NOT NULL ORDER BY marketCap DESC LIMIT 5;" && echo "" && echo "=== 5. Check if companies have logos ===" && sqlite3 modules/database/prisma/prod.db "SELECT COUNT(*) as with_logos FROM final_report WHERE logoUrl IS NOT NULL AND logoUrl != '';" && echo "" && echo "=== 6. Check server logs for API calls (last 20 lines) ===" && journalctl -u earnings-table -n 20 --no-pager | grep -E "Fetching FinalReport|Found.*records|Error fetching" | tail -10 || echo "No API logs found" && echo "" && echo "=== 7. Check if frontend file exists ===" && ls -lh simple-dashboard.html 2>/dev/null && echo "" && echo "=== 8. Test API response structure ===" && curl -s http://localhost:5555/api/final-report | jq -r '.data[0] | {symbol, name, marketCap, price, logoUrl}' 2>/dev/null || echo "Could not parse API response"

