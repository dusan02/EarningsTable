#!/bin/bash
# Finálna diagnóza - prečo sa pipeline nespúšťa a dátumy sú staré

cd /srv/EarningsTable && echo "═══════════════════════════════════════════════════════════" && echo "FINÁLNA DIAGNÓZA: PREČO SA DÁTA NEAKTUALIZUJÚ" && echo "═══════════════════════════════════════════════════════════" && echo "" && echo "1. Čo sa skutočne spúšťa (posledných 30 min):" && journalctl -u earnings-cron --since "30 minutes ago" --no-pager | grep -E "Starting|Pipeline|CRON|tick|unified" | tail -20 && echo "" && echo "2. Kontrola či sa unified pipeline naplánoval pri štarte:" && journalctl -u earnings-cron --since "2 hours ago" --no-pager | grep -E "Unified pipeline scheduled|All cron jobs started|Starting one-big-cron" | head -5 && echo "" && echo "3. Kontrola cron tickov (malo by byť každých 5 min):" && journalctl -u earnings-cron --since "30 minutes ago" --no-pager | grep -E "CRON.*tick|unified-slot" && echo "" && echo "4. Kontrola prečo sa dátumy nezapisujú správne:" && echo "   - reportDate v finnhub_data:" && sqlite3 modules/database/prisma/prod.db "SELECT symbol, datetime(reportDate, 'localtime') as reportDate FROM finnhub_data LIMIT 3;" && echo "   - updatedAt v final_report:" && sqlite3 modules/database/prisma/prod.db "SELECT symbol, datetime(updatedAt, 'localtime') as updatedAt FROM final_report LIMIT 3;" && echo "" && echo "5. Test - manuálne spustenie pipeline:" && echo "   (Toto by malo aktualizovať dáta)" && cd modules/cron && node node_modules/.bin/tsx src/main.ts start --once 2>&1 | head -30

