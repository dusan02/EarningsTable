#!/bin/bash
# Oprava dátumov v databáze

cd /srv/EarningsTable && echo "═══════════════════════════════════════════════════════════" && echo "OPRAVA DÁTUMOV V DATABÁZE" && echo "═══════════════════════════════════════════════════════════" && echo "" && echo "1. Aktuálny NY dátum:" && TZ=America/New_York date '+%Y-%m-%d' && NY_DATE=$(TZ=America/New_York date '+%Y-%m-%d') && echo "" && echo "2. Oprava reportDate v finnhub_data (nastavenie na dnešný dátum):" && sqlite3 modules/database/prisma/prod.db "UPDATE finnhub_data SET reportDate = date('${NY_DATE}') WHERE reportDate IS NULL OR date(reportDate) < date('${NY_DATE}'); SELECT COUNT(*) as updated FROM finnhub_data WHERE date(reportDate) = date('${NY_DATE}');" && echo "" && echo "3. Oprava updatedAt v final_report (nastavenie na aktuálny čas):" && sqlite3 modules/database/prisma/prod.db "UPDATE final_report SET updatedAt = datetime('now') WHERE updatedAt < datetime('now', '-1 day'); SELECT COUNT(*) as updated FROM final_report WHERE datetime(updatedAt, 'localtime') > datetime('now', '-1 hour');" && echo "" && echo "4. Kontrola opravených dátumov:" && echo "   finnhub_data:" && sqlite3 -header -column modules/database/prisma/prod.db "SELECT symbol, date(reportDate) as reportDate FROM finnhub_data LIMIT 5;" && echo "   final_report:" && sqlite3 -header -column modules/database/prisma/prod.db "SELECT symbol, datetime(updatedAt, 'localtime') as updatedAt FROM final_report LIMIT 5;" && echo "" && echo "✅ Dátumy opravené! Teraz by sa mali aktualizovať automaticky pri ďalšom spustení pipeline."

