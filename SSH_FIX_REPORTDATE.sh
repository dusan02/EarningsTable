#!/bin/bash
# Oprava reportDate v finnhub_data

cd /srv/EarningsTable && NY_DATE=$(TZ=America/New_York date '+%Y-%m-%d') && echo "═══════════════════════════════════════════════════════════" && echo "OPRAVA reportDate V finnhub_data" && echo "═══════════════════════════════════════════════════════════" && echo "Aktuálny NY dátum: $NY_DATE" && echo "" && echo "1. Kontrola aktuálneho stavu reportDate:" && sqlite3 -header -column modules/database/prisma/prod.db "SELECT symbol, reportDate, datetime(reportDate, 'localtime') as reportDate_local, datetime(createdAt, 'localtime') as createdAt FROM finnhub_data LIMIT 5;" && echo "" && echo "2. Kontrola či reportDate je NULL alebo má zlý formát:" && sqlite3 modules/database/prisma/prod.db "SELECT COUNT(*) as null_count FROM finnhub_data WHERE reportDate IS NULL;" && sqlite3 modules/database/prisma/prod.db "SELECT COUNT(*) as total_count FROM finnhub_data;" && echo "" && echo "3. Oprava reportDate (nastavenie na dnešný dátum pre všetky záznamy):" && sqlite3 modules/database/prisma/prod.db "UPDATE finnhub_data SET reportDate = datetime('$NY_DATE 00:00:00') WHERE reportDate IS NULL OR reportDate < datetime('$NY_DATE 00:00:00'); SELECT 'Updated: ' || changes() || ' records';" && echo "" && echo "4. Kontrola opravených dátumov:" && sqlite3 -header -column modules/database/prisma/prod.db "SELECT symbol, date(reportDate) as reportDate, datetime(reportDate, 'localtime') as reportDate_full FROM finnhub_data LIMIT 5;" && echo "" && echo "5. Kontrola final_report po oprave:" && sqlite3 -header -column modules/database/prisma/prod.db "SELECT symbol, date(reportDate) as reportDate, datetime(updatedAt, 'localtime') as updatedAt FROM final_report LIMIT 5;"

